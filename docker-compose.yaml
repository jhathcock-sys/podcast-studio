version: '3.8'

services:
  # LiveKit WebRTC Media Server
  livekit:
    image: livekit/livekit-server:latest
    container_name: podcast-livekit
    restart: unless-stopped
    ports:
      - "7880:7880"  # HTTP API
      - "7881:7881"  # WebRTC TCP
      - "7882:7882/udp"  # WebRTC UDP
    volumes:
      - ./livekit/config.yaml:/etc/livekit.yaml:ro
    command: --config /etc/livekit.yaml
    depends_on:
      - redis
    networks:
      - podcast-net

  # LiveKit Egress - Recording & Streaming
  livekit-egress:
    image: livekit/egress:latest
    container_name: podcast-egress
    restart: unless-stopped
    environment:
      - EGRESS_CONFIG_FILE=/etc/egress.yaml
    volumes:
      - ./livekit/egress.yaml:/etc/egress.yaml:ro
      - ./recordings:/output
    depends_on:
      - livekit
      - redis
    networks:
      - podcast-net

  # Redis - State Management
  redis:
    image: redis:7-alpine
    container_name: podcast-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - podcast-net

  # MinIO - S3-Compatible Storage
  minio:
    image: minio/minio:latest
    container_name: podcast-minio
    restart: unless-stopped
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - podcast-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Coturn - TURN Server for NAT Traversal
  coturn:
    image: coturn/coturn:latest
    container_name: podcast-coturn
    restart: unless-stopped
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "10000-20000:10000-20000/udp"
    volumes:
      - ./coturn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    command: -c /etc/coturn/turnserver.conf
    networks:
      - podcast-net

  # Frontend - React Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: podcast-frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      - VITE_API_URL=${VITE_API_URL}
      - VITE_LIVEKIT_URL=${VITE_LIVEKIT_URL}
    depends_on:
      - api
    networks:
      - podcast-net

  # API - Backend Server
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: podcast-api
    restart: unless-stopped
    ports:
      - "${API_PORT}:3333"
    environment:
      - NODE_ENV=${NODE_ENV}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - LIVEKIT_URL=${LIVEKIT_URL}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./api:/app
      - /app/node_modules
    depends_on:
      - redis
      - minio
    networks:
      - podcast-net

  # FFmpeg Worker - Post-Processing
  ffmpeg-worker:
    image: jrottenberg/ffmpeg:latest
    container_name: podcast-ffmpeg-worker
    restart: unless-stopped
    volumes:
      - ./recordings:/input:ro
      - ./processed:/output
      - ./scripts:/scripts:ro
    entrypoint: /bin/sh
    command: -c "while true; do sleep 30; done"
    networks:
      - podcast-net

networks:
  podcast-net:
    driver: bridge

volumes:
  redis-data:
  minio-data:
